



<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>goghチョコ</title>
<style>
  :root{
    --choco-1:#4b2e2a;
    --choco-2:#6f443f;
    --choco-3:#8b5a51;
    --cream:#f6e9d7;
    --accent:#d39b7d;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;background: linear-gradient(180deg,#2b1b18 0%, #1f1411 100%);color:var(--cream);}
  .app{
    max-width:1100px;margin:28px auto;padding:20px;border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
    box-shadow: 0 6px 30px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    display:flex;gap:20px;
  }

  /* Left: preview */
  .preview {
    width:640px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }
  .canvas-wrap{
    width:300px;
    height:300px;
    background:linear-gradient(180deg,#2a1b17 0%, #1a0f0d 100%);
    border-radius:14px;
    padding:12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 3px 0 rgba(255,255,255,0.03);
    display:flex;align-items:center;justify-content:center;position:relative;
  }
  canvas#composite{
    width:288px;height:288px;background:#fff;border-radius:8px;display:block;
    image-rendering: crisp-edges;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  /* Controls under preview */
  .controls{
    width:100%;
    display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  }
  .btn{
    background:linear-gradient(180deg,var(--choco-2),var(--choco-1));
    color:var(--cream);
    border:none;padding:10px 14px;border-radius:10px;cursor:pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    font-weight:600;
  }
  .btn.secondary{
    background: linear-gradient(180deg,var(--cream),#f0e7db);
    color:var(--choco-1);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
  }

  /* Right: layers list */
  .layers{
    flex:1;min-width:320px;max-width:420px;padding:8px;overflow:auto;
  }
  .layers h2{margin:6px 0 12px 10px;color:var(--cream);}
  .layer{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08));
    margin:8px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
  }
  .layer-header{
    display:flex;align-items:center;justify-content:space-between;gap:8px;
  }
  .layer-title{font-weight:700;color:var(--cream)}
  .toggle-btn{
    background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;color:var(--cream);cursor:pointer;
  }
  .options{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
  .opt{
    width:64px;height:64px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;
    border:2px solid rgba(0,0,0,0.3);cursor:pointer;position:relative;
  }
  .opt img{max-width:100%;max-height:100%;object-fit:cover;display:block;}
  .opt .label {
    position:absolute;bottom:2px;left:2px;right:2px;background:rgba(0,0,0,0.38);color:white;font-size:11px;padding:2px;border-radius:4px;text-align:center;
  }
  .swatch{
    width:48px;height:48px;border-radius:6px;border:1px solid rgba(0,0,0,0.2);
  }
  .opt.selected{outline:3px solid var(--accent);box-shadow: 0 4px 12px rgba(211,155,125,0.18);}
  .opt.hidden{display:none;}

  /* Text/draw tool */
  .toolbox{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0;}
  .size-indicator{width:36px;height:36px;border-radius:50%;background:#111;border:2px solid #222;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}

  /* small note */
  .note{position:fixed;right:14px;bottom:10px;font-size:12px;color:rgba(255,255,255,0.55);opacity:0.9}

  /* chocolate style buttons hover audio hint */
  .btn:hover{transform:translateY(-2px);}

  /* Responsive */
  @media (max-width:1100px){
    .app{flex-direction:column;align-items:center;}
    .preview{width:100%}
    .layers{width:100%}
  }

</style>
</head>
<body>
<div class="app" role="application" aria-label="カスタムお菓子メーカー">
  <div class="preview" aria-hidden="false">
    <div style="display:flex;align-items:center;gap:12px;width:100%;justify-content:space-between">
      <h1 style="margin:0;color:var(--cream);font-size:18px">バレンタイン</h1>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn" id="randomizeBtn" title="ランダム">ランダム</button>
        <button class="btn secondary" id="resetBtn" title="リセット">リセット</button>
        <button class="btn" id="saveBtn" title="画像を保存">保存</button>
      </div>
    </div>

    <div class="canvas-wrap">
      <!-- Visible composite canvas -->
      <canvas id="composite" width="288" height="288" aria-label="プレビュー"></canvas>

      <!-- drawing canvas (topmost) - same size but absolute overlay (we keep it in JS as offscreen + visible) -->
      <!-- We'll use an overlay element for pointer cursor and events: -->
      <canvas id="drawLayer" width="288" height="288" style="position:absolute;left:calc(50% - 144px);top:calc(50% - 144px);width:288px;height:288px;border-radius:8px;pointer-events:auto;"></canvas>
    </div>

    <div class="controls">
      <div class="toolbox">
        <button class="btn" id="writeModeBtn">ペン</button>
        <button class="btn" id="eraseModeBtn">消しゴム</button>
        <label style="display:flex;align-items:center;gap:6px;">
          <span style="font-size:13px;color:var(--cream)">太さ</span>
          <input id="sizeRange" type="range" min="2" max="40" value="9">
        </label>
        <div class="size-indicator" id="sizePreview"></div>
        <button class="btn secondary" id="clearDrawBtn">クリア</button>
      </div>
    </div>
  </div>

  <aside class="layers" aria-label="レイヤー一覧">
    <h2>レイヤー</h2>
    <div id="layersContainer"></div>
  </aside>
</div>

<div class="note"><a href="https://pocket-se.info/">ポケットサウンド/効果音素材</a></div>

<!-- audio elements -->
<audio id="hoverAudio" preload="auto" src="ppp.mp3"></audio>
<audio id="clickAudio" preload="auto" src="pp.mp3"></audio>

<script>
/*
  シングルファイルで完結するカスタムお菓子メーカーの実装
  - 各レイヤーは同サイズの画像群から選べる
  - 初期はランダムで1つずつ選択
  - レイヤーを切り替えるUI（1つだけ展開）
  - 描画（文字や手書き）用のトップレイヤー（黒、太さ可変）
  - 消しゴムは描画レイヤー上の描いた線のみ消す（下の画像は消さない）
  - 保存ボタンで合成してPNGをダウンロード
  - UIはチョコレート風の色合い
  - ボタンにホバーで ppp.mp3、クリックで pp.mp3 を再生（ファイルはルートに置いてください）
  - hidden フィールドで UI 上のボタンを非表示にしても画像は表示される
*/

/* ---------------------------
   ここでレイヤー定義（コード内でだけ設定）
   layers 配���の各要素:
     id: 数値（小さいほど下になる）
     title: 表示名
     editable: true/false（falseなら切り替えUIを表示しない）
     options: [ { label: "文字または色(#xxxx)", url: "https://...", hidden: true/false }, ... ]
   注意: 画像はすべて同じ縦横比・サイズである前提（例: 288x288）
---------------------------- */
const layers = [
  // 背景レイヤー（最下層）
  { id: 0, title: "背景", editable: true, options: [
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zzke-ki/main/1001.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1002.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1003.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1004.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1005.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1006.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1007.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1008.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1009.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1010.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1011.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1012.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1013.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1014.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1015.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1016.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1017.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1018.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1019.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1020.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1021.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1022.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1023.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1024.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1025.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1026.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1027.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1028.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1029.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1030.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1031.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1032.png", hidden: false },
      { label:"木目", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1033.png", hidden: false }
    ]},
  // 袋
  { id: 1, title: "袋色", editable: true, options: [
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/201.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/202.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/203.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/204.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/205.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/206.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/207.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/208.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/209.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/211.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/212.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/213.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/214.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/215.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/216.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/217.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/218.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/219.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/221.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/222.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/223.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/224.png", hidden: false },
      { label:"赤袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/225.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/226.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/227.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/220.png", hidden: false },
      { label:"茶色袋", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/210.png", hidden: false }
    ]},
  // ロゴ等
  { id: 2, title: "クリーム", editable: true, options: [
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/301.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/302.png", hidden: false },
      { label:"ロゴB", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/303.png", hidden: false }
    ]},
  { id: 3, title: "板チョコ", editable: true, options: [
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/401.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/402.png", hidden: false },
      { label:"ロゴB", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/403.png", hidden: false }
    ]},
  { id: 5, title: "おもちゃ", editable: true, options: [
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/501.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/502.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/503.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/504.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/505.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/506.png", hidden: false }
    ]},
  // エフェクト
  { id: 6, title: "", editable: true, options: [
      { label:"きらめき", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/801.png", hidden: true }
    ]},
  { id: 7, title: "おもちゃ", editable: true, options: [
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/601.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/602.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/603.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/604.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/605.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/606.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/607.png", hidden: false },
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/608.png", hidden: false }
    ]},
  { id: 8, title: "おもちゃ2", editable: true, options: [
      { label:"ロゴA", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/901.png", hidden: true }
    ]},
  
  // 最上位（描画は専用レイヤーとして扱いますが、見た目上のレイヤー情報を持たせる）
  { id: 9, title: "", editable: false, options: [] }
];
/* ---------------------------
   内部状態
---------------------------- */
const state = {
  selected: {}, // layerId -> optionIndex
  imagesCache: {}, // url -> HTMLImageElement
  expandOpen: null, // 展開されているレイヤーID（1つだけ）
  canvasSize: 526

/* Elements */
const layersContainer = document.getElementById('layersContainer');
const composite = document.getElementById('composite');
const drawLayer = document.getElementById('drawLayer');
const ctx = composite.getContext('2d',{alpha:true});
const drawCtx = drawLayer.getContext('2d',{alpha:true});
const hoverAudio = document.getElementById('hoverAudio');
const clickAudio = document.getElementById('clickAudio');
const sizeRange = document.getElementById('sizeRange');
const sizePreview = document.getElementById('sizePreview');
const writeModeBtn = document.getElementById('writeModeBtn');
const eraseModeBtn = document.getElementById('eraseModeBtn');
const clearDrawBtn = document.getElementById('clearDrawBtn');
const randomizeBtn = document.getElementById('randomizeBtn');
const resetBtn = document.getElementById('resetBtn');
const saveBtn = document.getElementById('saveBtn');

/* Play sounds on all buttons: hover -> ppp.mp3, click -> pp.mp3 */
function attachButtonSound(el){
  el.addEventListener('mouseenter', ()=>{ try{ hoverAudio.currentTime=0; hoverAudio.play(); }catch(e){} });
  el.addEventListener('click', ()=>{ try{ clickAudio.currentTime=0; clickAudio.play(); }catch(e){} });
}
/* Attach to existing buttons */
document.querySelectorAll('button,input[type="range"]').forEach(attachButtonSound);

/* Helper: load image with cache */
function loadImage(url){
  return new Promise((resolve)=>{
    if(!url){ resolve(null); return; }
    if(state.imagesCache[url]) {
      if(state.imagesCache[url].complete) resolve(state.imagesCache[url]);
      else state.imagesCache[url].addEventListener('load', ()=>resolve(state.imagesCache[url]));
      return;
    }
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>{ state.imagesCache[url] = img; resolve(img); };
    img.onerror = ()=>{ console.warn('image load error',url); resolve(null); };
    img.src = url;
    state.imagesCache[url] = img;
  });
}

/* Build layer UI */
function buildLayersUI(){
  layersContainer.innerHTML = '';
  layers.sort((a,b)=>a.id-b.id).forEach(layer=>{
    const wrap = document.createElement('div'); wrap.className='layer'; wrap.dataset.layerId = layer.id;
    const header = document.createElement('div'); header.className='layer-header';
    const title = document.createElement('div'); title.className='layer-title'; title.textContent = `${layer.title}`;
    header.appendChild(title);

    if(layer.editable){
      const toggle = document.createElement('button'); toggle.className='toggle-btn'; toggle.innerHTML = '&#x3e;'; // >
      toggle.title = '切り替えを表示';
      toggle.addEventListener('click', (e)=>{
        // only one open at a time
        if(state.expandOpen === layer.id) state.expandOpen = null;
        else state.expandOpen = layer.id;
        renderLayers(); // re-render to show/hide
      });
      header.appendChild(toggle);
    } else {
      const lock = document.createElement('div'); lock.style.opacity=0.7; lock.style.fontSize='13px'; lock.textContent='編集不可';
      header.appendChild(lock);
    }

    wrap.appendChild(header);

    // options container (will be toggled)
    const opts = document.createElement('div'); opts.className='options'; opts.style.display = (state.expandOpen===layer.id ? 'flex' : 'none');

    if(layer.editable){
      // populate options
      layer.options.forEach(async (opt, idx)=>{
        const el = document.createElement('div'); el.className='opt';
        if(opt.hidden) el.classList.add('hidden');
        el.title = opt.label || ('option-'+idx);
        // if label is color
        const isColor = /^#([0-9a-f]{3,8})$/i.test(opt.label);
        if(isColor){
          const sw = document.createElement('div'); sw.className='swatch';
          sw.style.background = opt.label;
          el.appendChild(sw);
        } else if(opt.url){
          const img = document.createElement('img'); img.src = opt.url; img.alt = opt.label || '';
          el.appendChild(img);
          // small label
          const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent = opt.label;
          el.appendChild(lbl);
        } else {
          // just text label (no image)
          const txt = document.createElement('div'); txt.style.padding='4px'; txt.style.fontSize='13px'; txt.textContent = opt.label || 'none';
          el.appendChild(txt);
        }

        // selected highlight
        if(state.selected[layer.id] === idx) el.classList.add('selected');
        el.addEventListener('click', async ()=>{
          state.selected[layer.id] = idx;
          state.expandOpen = null;
          renderLayers();
          await redrawComposite();
        });
        opts.appendChild(el);
        // preload images
        if(opt.url) loadImage(opt.url);
      });
    } else {
      const hint = document.createElement('div'); hint.style.fontSize='13px'; hint.style.opacity=0.8; hint.textContent = 'このレイヤーは描画専用です';
      opts.appendChild(hint);
    }

    wrap.appendChild(opts);
    layersContainer.appendChild(wrap);
  });
}

/* Render layers UI depending on state (keeps selection border) */
function renderLayers(){
  // rebuild to reflect selected/expanded states
  buildLayersUI();
}

/* Choose random initial selections */
function randomizeSelections(){
  layers.forEach(layer=>{
    if(!layer.editable) return;
    if(!layer.options || layer.options.length===0) return;
    // フィルター: hidden でないオプションのみ
    const visibleOpts = layer.options.filter(o => !o.hidden);
    if(visibleOpts.length === 0) return;
    const idx = layer.options.indexOf(visibleOpts[Math.floor(Math.random()*visibleOpts.length)]);
    state.selected[layer.id] = idx;
  });
}

/* Reset to first visible options (or blank) */
function resetSelections(){
  layers.forEach(layer=>{
    if(!layer.editable) return;
    if(!layer.options || layer.options.length===0) return;
    // 最初の hidden でないオプションを探す
    const firstVisibleIdx = layer.options.findIndex(o => !o.hidden);
    if(firstVisibleIdx >= 0) state.selected[layer.id] = firstVisibleIdx;
    else state.selected[layer.id] = 0;
  });
}

/* Draw composite canvas in order of layer.id ascending */
async function redrawComposite(){
  const size = state.canvasSize;
  ctx.clearRect(0,0,size,size);
  ctx.clearRect(0,0,size,size);

  for(const layer of layers){
    if(layer.id === 8) continue; // drawing handled separately
    if(!layer.editable) continue;
    const sel = state.selected[layer.id];
    if(sel === undefined) continue;
    const opt = layer.options[sel];
    if(!opt) continue;
    // if option url is empty (e.g. "なし"), skip (leave transparent)
    if(!opt.url) continue;
    const img = await loadImage(opt.url);
    if(!img) continue;
    // draw image scaled to fit canvas (cover)
    drawImageCover(ctx, img, 0,0,size,size);
  }
  // finally composite the drawLayer (user drawing) above
  // we copy pixels from drawCtx (visible canvas) to composite ctx:
  ctx.drawImage(drawLayer, 0,0, size, size);
}

/* drawImageCover: cover-style draw (like CSS background-size:cover) */
function drawImageCover(ctx, img, x, y, w, h){
  const iw = img.width, ih = img.height;
  if(!iw || !ih){ ctx.globalAlpha = 1; return; }
  const r = Math.max(w/iw, h/ih);
  const nw = iw * r, nh = ih * r;
  const cx = (nw - w) / 2, cy = (nh - h) / 2;
  ctx.drawImage(img, -cx + x, -cy + y, nw, nh);
}

/* Save composite to PNG and download */
async function saveComposite(){
  // create temporary canvas to composite all layers and drawing at full size
  const size = state.canvasSize;
  const tmp = document.createElement('canvas'); tmp.width = size; tmp.height = size;
  const tctx = tmp.getContext('2d');
  // background (white)
  tctx.clearRect(0,0,size,size);
  for(const layer of layers){
    if(layer.id === 8) continue;
    if(!layer.editable) continue;
    const sel = state.selected[layer.id];
    if(sel === undefined) continue;
    const opt = layer.options[sel];
    if(!opt) continue;
    if(!opt.url) continue;
    const img = await loadImage(opt.url);
    if(!img) continue;
    drawImageCover(tctx, img, 0,0,size,size);
  }
  // draw the drawing layer on top
  tctx.drawImage(drawLayer, 0,0, size, size);
  // download
  const a = document.createElement('a');
  a.href = tmp.toDataURL('image/png');
  a.download = `custom_snack_${Date.now()}.png`;
  a.click();
}

/* ---------------------------
   Drawing (手書き / 消しゴム)
   We use drawLayer canvas for visible strokes and keep everything there.
   Eraser should only erase what's drawn (not underlying images) -> using destination-out is enough
   because we only modify drawLayer.
---------------------------- */
let drawing = false;
let erasing = false;
let brushSize = parseInt(sizeRange.value,10) || 9;
sizePreview.style.width = sizePreview.style.height = Math.max(28,brushSize*0.7)+'px';
sizePreview.textContent = '';
drawCtx.lineCap = 'round';
drawCtx.lineJoin = 'round';
drawCtx.strokeStyle = '#000';
drawCtx.lineWidth = brushSize;

function setBrushSize(s){
  brushSize = s;
  drawCtx.lineWidth = brushSize;
  sizePreview.style.width = sizePreview.style.height = Math.max(28,brushSize*0.7)+'px';
}

sizeRange.addEventListener('input', (e)=>{ setBrushSize(parseInt(e.target.value,10)); });

writeModeBtn.addEventListener('click', ()=>{
  erasing = false;
  writeModeBtn.style.opacity = 1;
  eraseModeBtn.style.opacity = 0.8;
});
eraseModeBtn.addEventListener('click', ()=>{
  erasing = true;
  eraseModeBtn.style.opacity = 1;
  writeModeBtn.style.opacity = 0.8;
});
clearDrawBtn.addEventListener('click', ()=>{ drawCtx.clearRect(0,0,drawLayer.width,drawLayer.height); redrawComposite(); });

/* pointer events for drawing */
function getPointerPos(evt){
  const rect = drawLayer.getBoundingClientRect();
  const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
  const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
  const x = (clientX - rect.left) * (drawLayer.width / rect.width);
  const y = (clientY - rect.top) * (drawLayer.height / rect.height);
  return {x,y};
}

let last = null;
function pointerDown(e){
  e.preventDefault();
  drawing = true;
  last = getPointerPos(e);
  drawCtx.save();
  if(erasing){
    // eraser: make composite operation that removes pixels from drawLayer only
    drawCtx.globalCompositeOperation = 'destination-out';
    drawCtx.strokeStyle = 'rgba(0,0,0,1)';
  } else {
    drawCtx.globalCompositeOperation = 'source-over';
    drawCtx.strokeStyle = '#000';
  }
  drawCtx.lineWidth = brushSize;
  drawCtx.beginPath();
  drawCtx.moveTo(last.x,last.y);
}
function pointerMove(e){
  if(!drawing) return;
  const p = getPointerPos(e);
  drawCtx.lineTo(p.x,p.y);
  drawCtx.stroke();
  last = p;
}
function pointerUp(e){
  if(!drawing) return;
  drawing = false;
  drawCtx.closePath();
  drawCtx.restore();
  redrawComposite(); // update preview composite
}
drawLayer.addEventListener('mousedown', pointerDown);
drawLayer.addEventListener('touchstart', pointerDown, {passive:false});
window.addEventListener('mousemove', pointerMove);
window.addEventListener('touchmove', pointerMove, {passive:false});
window.addEventListener('mouseup', pointerUp);
window.addEventListener('touchend', pointerUp);

/* initialization */
async function init(){
  // ensure drawLayer is cleared and background white for preview if desired
  drawLayer.style.pointerEvents='auto';
  // random initial selections
  randomizeSelections();
  buildLayersUI();
  await redrawComposite();

  // set default modes
  writeModeBtn.style.opacity = 1;
  eraseModeBtn.style.opacity = 0.8;

  // wire buttons
  randomizeBtn.addEventListener('click', async ()=>{
    randomizeSelections();
    renderLayers();
    await redrawComposite();
  });
  resetBtn.addEventListener('click', async ()=>{
    resetSelections();
    renderLayers();
    await redrawComposite();
  });
  saveBtn.addEventListener('click', saveComposite);

  // keyboard: 'e' toggle eraser
  window.addEventListener('keydown',(e)=>{ if(e.key==='e') { erasing = !erasing; eraseModeBtn.style.opacity = erasing?1:0.8; writeModeBtn.style.opacity = erasing?0.8:1; } });

  // small: render initial selected highlighting
  renderLayers();
}

/* Start */
init();

</script>
</body>
</html>
