<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>goghチョコ</title>
<style>
  :root{
    --choco-1:#4b2e2a;
    --choco-2:#6f443f;
    --choco-3:#8b5a51;
    --cream:#f6e9d7;
    --accent:#d39b7d;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;background: linear-gradient(180deg,#2b1b18 0%, #1f1411 100%);color:var(--cream);}
  .app{
    max-width:1100px;margin:28px auto;padding:20px;border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
    box-shadow: 0 6px 30px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    display:flex;gap:20px;
  }

  /* Left: preview */
  .preview {
    width:640px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }
  .canvas-wrap{
    width:550px;
    height:550px;
    background:linear-gradient(180deg,#2a1b17 0%, #1a0f0d 100%);
    border-radius:14px;
    padding:12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 3px 0 rgba(255,255,255,0.03);
    display:flex;align-items:center;justify-content:center;position:relative;
  }
  canvas#composite{
    width:526px;height:526px;background:#fff;border-radius:8px;display:block;
    image-rendering: crisp-edges;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  /* Controls under preview */
  .controls{
    width:100%;
    display:flex;gap:8px;align-items:center;justify-content:space-between;
    flex-wrap:wrap;
  }
  .btn{
    background:linear-gradient(180deg,var(--choco-2),var(--choco-1));
    color:var(--cream);
    border:none;padding:10px 14px;border-radius:10px;cursor:pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    font-weight:600;
  }
  .btn.secondary{
    background: linear-gradient(180deg,var(--cream),#f0e7db);
    color:var(--choco-1);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
  }

  /* Right: layers list */
  .layers{
    flex:1;min-width:320px;max-width:420px;padding:8px;overflow:auto;
    max-height:700px;
  }
  .layers h2{margin:6px 0 12px 10px;color:var(--cream);}
  .layer{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08));
    margin:8px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
  }
  .layer.hidden-ui{
    display:none;
  }
  .layer-header{
    display:flex;align-items:center;justify-content:space-between;gap:8px;
  }
  .layer-title{font-weight:700;color:var(--cream)}
  .toggle-btn{
    background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;color:var(--cream);cursor:pointer;
    transition: all 0.2s ease;
  }
  .toggle-btn:hover{
    background:rgba(255,255,255,0.05);
  }
  .toggle-btn.open{
    transform: rotate(90deg);
  }
  .options{margin-top:10px;display:none;flex-wrap:wrap;gap:8px;}
  .options.open{display:flex;}
  .opt{
    width:56px;height:56px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;
    border:2px solid rgba(0,0,0,0.3);cursor:pointer;position:relative;
    transition: all 0.15s ease;
  }
  .opt:hover{
    transform: scale(1.08);
  }
  .opt img{max-width:100%;max-height:100%;object-fit:cover;display:block;}
  .opt .label {
    position:absolute;bottom:2px;left:2px;right:2px;background:rgba(0,0,0,0.38);color:white;font-size:10px;padding:2px;border-radius:4px;text-align:center;
    max-height:20px;overflow:hidden;text-overflow:ellipsis;
  }
  .swatch{
    width:48px;height:48px;border-radius:6px;border:1px solid rgba(0,0,0,0.2);
  }
  .opt.selected{outline:3px solid var(--accent);box-shadow: 0 4px 12px rgba(211,155,125,0.18);}

  /* Text/draw tool */
  .toolbox{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0;}
  .size-indicator{width:32px;height:32px;border-radius:50%;background:#111;border:2px solid #222;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:12px;}

  /* small note */
  .note{position:fixed;right:14px;bottom:10px;font-size:12px;color:rgba(255,255,255,0.55);opacity:0.9}

  /* chocolate style buttons hover audio hint */
  .btn:hover{transform:translateY(-2px);}

  /* Responsive */
  @media (max-width:1100px){
    .app{flex-direction:column;align-items:center;}
    .preview{width:100%}
    .layers{width:100%;max-height:none;}
  }

</style>
</head>
<body>
<div class="app" role="application" aria-label="カスタムお菓子メーカー">
  <div class="preview" aria-hidden="false">
    <div style="display:flex;align-items:center;gap:12px;width:100%;justify-content:space-between;flex-wrap:wrap;">
      <h1 style="margin:0;color:var(--cream);font-size:18px">バレンタイン</h1>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="btn" id="randomizeBtn" title="ランダム">ランダム</button>
        <button class="btn secondary" id="resetBtn" title="リセット">リセット</button>
        <button class="btn" id="saveBtn" title="画像を保存">保存</button>
      </div>
    </div>

    <div class="canvas-wrap">
      <canvas id="composite" width="526" height="526" aria-label="プレビュー"></canvas>
      <canvas id="drawLayer" width="526" height="526" style="position:absolute;left:calc(50% - 263px);top:calc(50% - 263px);width:526px;height:526px;border-radius:8px;pointer-events:auto;"></canvas>
    </div>

    <div class="controls">
      <div class="toolbox">
        <button class="btn" id="writeModeBtn">ペン</button>
        <button class="btn" id="eraseModeBtn">消しゴム</button>
        <label style="display:flex;align-items:center;gap:6px;">
          <span style="font-size:13px;color:var(--cream)">太さ</span>
          <input id="sizeRange" type="range" min="1" max="40" value="9">
        </label>
        <div class="size-indicator" id="sizePreview"></div>
        <button class="btn secondary" id="clearDrawBtn">クリア</button>
      </div>
    </div>
  </div>

  <aside class="layers" aria-label="レイヤー一覧">
    <h2>レイヤー</h2>
    <div id="layersContainer"></div>
  </aside>
</div>

<div class="note">
  <p>※gogh二次創作ガイドラインの範囲内で<br>ご自由にご利用ください。</p>
  <p>※非公式</p>
  <p><a href="https://pocket-se.info/">ポケットサウンド</a></p>
</div>


<audio id="hoverAudio" preload="auto" src="ppp.mp3"></audio>
<audio id="clickAudio" preload="auto" src="pp.mp3"></audio>

<script>
/*
  シングルファイルで完結するカスタムお菓子メーカーの実装
  - キャンバスサイズ: 526×526
  - 各レイヤーは同サイズの画像群から選べる
  - 初期はランダムで1つずつ選択
  - レイヤーを切り替えるUI（1つだけ展開、明示的に閉じるボタンで戻す）
  - hidden: true の場合、UIボタンは非表示だが画像は表示される
  - タイトルの横にID表示なし
  - 背景チェックボタンなし
  - 色のマークなし
  - 描画レイヤー: 黒、太さ可変（最大40、初期9）
  - 消しゴム: 描いた線のみ消す
  - 保存ボタンで合成してPNGをダウンロード
  - UIはチョコ風カラー
  - ボタンにホバーで ppp.mp3、クリックで pp.mp3 を再生
*/

const layers = [
  { id: 0, title: "背景", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zzke-ki/main/1001.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1002.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1003.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1004.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1005.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1006.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1007.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1008.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1009.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1010.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1011.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1012.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1013.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1014.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1015.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1016.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1017.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1018.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1019.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1020.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1021.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1022.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1023.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1024.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1025.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1026.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1027.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1028.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1029.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1030.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1031.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1032.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/1033.png", hidden: false }
    ]},
  { id: 1, title: "袋色", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/201.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/202.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/203.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/204.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/205.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/206.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/207.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/208.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/209.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/211.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/212.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/213.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/214.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/215.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/216.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/217.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/218.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/219.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/221.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/222.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/223.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/224.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/225.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/226.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/227.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/220.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/210.png", hidden: false }
    ]},
  { id: 2, title: "クリーム", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/301.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/302.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/303.png", hidden: false }
    ]},
  { id: 3, title: "板チョコ", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/401.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/402.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/403.png", hidden: false }
    ]},
  { id: 5, title: "キャラクター", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/501.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/502.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/503.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/504.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/505.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/506.png", hidden: false }
    ]},
  { id: 6, title: "", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/801.png", hidden: false }
    ]},
  { id: 7, title: "フレーム", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/601.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/602.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/603.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/604.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/605.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/606.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/607.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/608.png", hidden: false }
    ]},

  { id: 10, title: "キャラ枠", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/701.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/702.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/703.png", hidden: false },
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/704.png", hidden: false },
        { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/000.png", hidden: false }
  
  { id: 8, title: "", editable: true, options: [
      { label:"", url:"https://raw.githubusercontent.com/zzcafe-280/zztyoko/main/901.png", hidden: false }
    ]},
  { id: 9, title: "", editable: false, options: [] }
];

const state = {
  selected: {},
  imagesCache: {},
  expandOpen: null,
  canvasSize: 526
};

const layersContainer = document.getElementById('layersContainer');
const composite = document.getElementById('composite');
const drawLayer = document.getElementById('drawLayer');
const ctx = composite.getContext('2d',{alpha:true});
const drawCtx = drawLayer.getContext('2d',{alpha:true});
const hoverAudio = document.getElementById('hoverAudio');
const clickAudio = document.getElementById('clickAudio');
const sizeRange = document.getElementById('sizeRange');
const sizePreview = document.getElementById('sizePreview');
const writeModeBtn = document.getElementById('writeModeBtn');
const eraseModeBtn = document.getElementById('eraseModeBtn');
const clearDrawBtn = document.getElementById('clearDrawBtn');
const randomizeBtn = document.getElementById('randomizeBtn');
const resetBtn = document.getElementById('resetBtn');
const saveBtn = document.getElementById('saveBtn');

function attachButtonSound(el){
  el.addEventListener('mouseenter', ()=>{ try{ hoverAudio.currentTime=0; hoverAudio.play(); }catch(e){} });
  el.addEventListener('click', ()=>{ try{ clickAudio.currentTime=0; clickAudio.play(); }catch(e){} });
}

function loadImage(url){
  return new Promise((resolve)=>{
    if(!url){ resolve(null); return; }
    if(state.imagesCache[url]) {
      if(state.imagesCache[url].complete) resolve(state.imagesCache[url]);
      else state.imagesCache[url].addEventListener('load', ()=>resolve(state.imagesCache[url]));
      return;
    }
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>{ state.imagesCache[url] = img; resolve(img); };
    img.onerror = ()=>{ console.warn('image load error',url); resolve(null); };
    img.src = url;
    state.imagesCache[url] = img;
  });
}

function buildLayersUI(){
  layersContainer.innerHTML = '';
  layers.sort((a,b)=>a.id-b.id).forEach(layer=>{
    const wrap = document.createElement('div'); 
    wrap.className='layer'; 
    wrap.dataset.layerId = layer.id;
    
    // ボタンが非表示の場合のみクラスを追加（ただし層自体は表示）
    const hasHiddenOptions = layer.editable && layer.options && layer.options.some(o => o.hidden);
    const allHidden = layer.editable && layer.options && layer.options.every(o => o.hidden);
    if(allHidden) wrap.classList.add('hidden-ui');

    const header = document.createElement('div'); 
    header.className='layer-header';
    const title = document.createElement('div'); 
    title.className='layer-title'; 
    title.textContent = layer.title;
    header.appendChild(title);

    if(layer.editable){
      const toggle = document.createElement('button'); 
      toggle.className='toggle-btn'; 
      toggle.innerHTML = '&#x3e;';
      toggle.title = '切り替えを表示/非表示';
      toggle.addEventListener('click', (e)=>{
        e.preventDefault();
        if(state.expandOpen === layer.id) {
          state.expandOpen = null;
        } else {
          state.expandOpen = layer.id;
        }
        renderLayers();
      });
      header.appendChild(toggle);
    } else {
      const lock = document.createElement('div'); 
      lock.style.opacity=0.7; 
      lock.style.fontSize='13px'; 
      lock.textContent='編集不可';
      header.appendChild(lock);
    }

    wrap.appendChild(header);

    const opts = document.createElement('div'); 
    opts.className='options'; 
    if(state.expandOpen === layer.id) opts.classList.add('open');

    if(layer.editable){
      layer.options.forEach(async (opt, idx)=>{
        // hidden: true の場合、ボタンを作らない（画像は下レイヤーで表示される）
        if(opt.hidden) return;

        const el = document.createElement('div'); 
        el.className='opt';
        el.title = opt.label || ('option-'+idx);
        
        const isColor = /^#([0-9a-f]{3,8})$/i.test(opt.label);
        if(isColor){
          const sw = document.createElement('div'); 
          sw.className='swatch';
          sw.style.background = opt.label;
          el.appendChild(sw);
        } else if(opt.url){
          const img = document.createElement('img'); 
          img.src = opt.url; 
          img.alt = opt.label || '';
          el.appendChild(img);
          const lbl = document.createElement('div'); 
          lbl.className='label'; 
          lbl.textContent = opt.label;
          el.appendChild(lbl);
        } else {
          const txt = document.createElement('div'); 
          txt.style.padding='4px'; 
          txt.style.fontSize='13px'; 
          txt.textContent = opt.label || 'none';
          el.appendChild(txt);
        }

        if(state.selected[layer.id] === idx) el.classList.add('selected');
        
        el.addEventListener('click', async ()=>{
          state.selected[layer.id] = idx;
          renderLayers();
          await redrawComposite();
        });
        
        opts.appendChild(el);
        if(opt.url) loadImage(opt.url);
      });
    } else {
      const hint = document.createElement('div'); 
      hint.style.fontSize='13px'; 
      hint.style.opacity=0.8; 
      hint.textContent = 'このレイヤーは描画専用です';
      opts.appendChild(hint);
    }

    wrap.appendChild(opts);
    layersContainer.appendChild(wrap);
  });
  
  document.querySelectorAll('.toggle-btn').forEach(btn => attachButtonSound(btn));
}

function renderLayers(){
  buildLayersUI();
}

function randomizeSelections(){
  layers.forEach(layer=>{
    if(!layer.editable) return;
    if(!layer.options || layer.options.length===0) return;
    const visibleOptions = layer.options.filter(o => !o.hidden);
    if(visibleOptions.length === 0) {
      // すべて hidden の場合は最初の hidden option を選ぶ
      state.selected[layer.id] = 0;
    } else {
      const randomIdx = Math.floor(Math.random() * visibleOptions.length);
      const actualIdx = layer.options.indexOf(visibleOptions[randomIdx]);
      state.selected[layer.id] = actualIdx;
    }
  });
}

function resetSelections(){
  layers.forEach(layer=>{
    if(!layer.editable) return;
    state.selected[layer.id] = 0;
  });
}

async function redrawComposite(){
  const size = state.canvasSize;
  ctx.clearRect(0,0,size,size);
  ctx.save();
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,size,size);
  ctx.restore();

  for(const layer of layers){
    if(layer.id === 9) continue;
    if(!layer.editable) continue;
    const sel = state.selected[layer.id];
    if(sel === undefined) continue;
    const opt = layer.options[sel];
    if(!opt) continue;
    if(!opt.url) continue;
    const img = await loadImage(opt.url);
    if(!img) continue;
    drawImageCover(ctx, img, 0,0,size,size);
  }
  ctx.drawImage(drawLayer, 0,0, size, size);
}

function drawImageCover(ctx, img, x, y, w, h){
  const iw = img.width, ih = img.height;
  if(!iw || !ih){ ctx.globalAlpha = 1; return; }
  const r = Math.max(w/iw, h/ih);
  const nw = iw * r, nh = ih * r;
  const cx = (nw - w) / 2, cy = (nh - h) / 2;
  ctx.drawImage(img, -cx + x, -cy + y, nw, nh);
}

async function saveComposite(){
  const size = state.canvasSize;
  const tmp = document.createElement('canvas'); 
  tmp.width = size; 
  tmp.height = size;
  const tctx = tmp.getContext('2d');
  tctx.clearRect(0,0,size,size);
  tctx.save();
  tctx.fillStyle = '#fff';
  tctx.fillRect(0,0,size,size);
  tctx.restore();

  for(const layer of layers){
    if(layer.id === 9) continue;
    if(!layer.editable) continue;
    const sel = state.selected[layer.id];
    if(sel === undefined) continue;
    const opt = layer.options[sel];
    if(!opt) continue;
    if(!opt.url) continue;
    const img = await loadImage(opt.url);
    if(!img) continue;
    drawImageCover(tctx, img, 0,0,size,size);
  }
  tctx.drawImage(drawLayer, 0,0, size, size);
  
  const a = document.createElement('a');
  a.href = tmp.toDataURL('image/png');
  a.download = `custom_snack_${Date.now()}.png`;
  a.click();
}

let drawing = false;
let erasing = false;
let brushSize = parseInt(sizeRange.value,10) || 9;
sizePreview.style.width = sizePreview.style.height = Math.max(24,brushSize*0.8)+'px';
sizePreview.textContent = '';
drawCtx.lineCap = 'round';
drawCtx.lineJoin = 'round';
drawCtx.strokeStyle = '#000';
drawCtx.lineWidth = brushSize;

function setBrushSize(s){
  brushSize = s;
  drawCtx.lineWidth = brushSize;
  sizePreview.style.width = sizePreview.style.height = Math.max(24,brushSize*0.8)+'px';
}

sizeRange.addEventListener('input', (e)=>{ setBrushSize(parseInt(e.target.value,10)); });

writeModeBtn.addEventListener('click', ()=>{
  erasing = false;
  writeModeBtn.style.opacity = 1;
  eraseModeBtn.style.opacity = 0.8;
});

eraseModeBtn.addEventListener('click', ()=>{
  erasing = true;
  eraseModeBtn.style.opacity = 1;
  writeModeBtn.style.opacity = 0.8;
});

clearDrawBtn.addEventListener('click', ()=>{ 
  drawCtx.clearRect(0,0,drawLayer.width,drawLayer.height); 
  redrawComposite(); 
});

function getPointerPos(evt){
  const rect = drawLayer.getBoundingClientRect();
  const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
  const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
  const x = (clientX - rect.left) * (drawLayer.width / rect.width);
  const y = (clientY - rect.top) * (drawLayer.height / rect.height);
  return {x,y};
}

let last = null;
function pointerDown(e){
  e.preventDefault();
  drawing = true;
  last = getPointerPos(e);
  drawCtx.save();
  if(erasing){
    drawCtx.globalCompositeOperation = 'destination-out';
    drawCtx.strokeStyle = 'rgba(0,0,0,1)';
  } else {
    drawCtx.globalCompositeOperation = 'source-over';
    drawCtx.strokeStyle = '#000';
  }
  drawCtx.lineWidth = brushSize;
  drawCtx.beginPath();
  drawCtx.moveTo(last.x,last.y);
}

function pointerMove(e){
  if(!drawing) return;
  const p = getPointerPos(e);
  drawCtx.lineTo(p.x,p.y);
  drawCtx.stroke();
  last = p;
}

function pointerUp(e){
  if(!drawing) return;
  drawing = false;
  drawCtx.closePath();
  drawCtx.restore();
  redrawComposite();
}

drawLayer.addEventListener('mousedown', pointerDown);
drawLayer.addEventListener('touchstart', pointerDown, {passive:false});
window.addEventListener('mousemove', pointerMove);
window.addEventListener('touchmove', pointerMove, {passive:false});
window.addEventListener('mouseup', pointerUp);
window.addEventListener('touchend', pointerUp);

async function init(){
  drawLayer.style.pointerEvents='auto';
  randomizeSelections();
  buildLayersUI();
  await redrawComposite();

  writeModeBtn.style.opacity = 1;
  eraseModeBtn.style.opacity = 0.8;

  randomizeBtn.addEventListener('click', async ()=>{
    randomizeSelections();
    renderLayers();
    await redrawComposite();
  });

  resetBtn.addEventListener('click', async ()=>{
    resetSelections();
    renderLayers();
    await redrawComposite();
  });

  saveBtn.addEventListener('click', saveComposite);

  window.addEventListener('keydown',(e)=>{ 
    if(e.key==='e') { 
      erasing = !erasing; 
      eraseModeBtn.style.opacity = erasing?1:0.8; 
      writeModeBtn.style.opacity = erasing?0.8:1; 
    } 
  });

  document.querySelectorAll('button').forEach(attachButtonSound);
  renderLayers();
}

init();

</script>
</body>
</html>
